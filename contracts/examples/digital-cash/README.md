# Digital Cash Contract

The basic idea of MultiversX Digital Cash is that a cryptographic check (represented by an ED25519 public key) can hold tokens (ESDT or EGLD) on-chain. This check can be transferred from one person to another through a simple link. The recipient doesn't need a wallet initially - they just need to prove ownership of the check's private key through an ED25519 signature to claim the funds.

## Overview

Each deposit is stored at a specific 32-byte key (the ED25519 public key, also called the "check address"). To claim funds:
1. The recipient must provide a valid ED25519 signature proving they control the deposit key's private key
2. The signature must sign the claimer's address
3. The deposit must not have expired
4. Fees must have been paid upfront by the depositor (if fees are enabled)

## Fee System

The contract supports a flexible fee configuration system:

### Global Fee Toggle
The contract owner can enable or disable fees globally using `setFeesDisabled`:
- When **disabled** (`fees_disabled = true`): No fees are required for any operation
- When **enabled** (`fees_disabled = false`): Fees are validated according to configured fee variants

### Fee Variants
Each token can be configured with a specific fee amount using the `setFee` endpoint:
- Setting a fee amount > 0 makes that token valid for paying fees
- Setting a fee amount = 0 effectively disables that token for fees
- The fee is charged per fund: `total_fee = base_fee × number_of_funds_in_deposit`

Fees must be paid upfront when creating a deposit and must cover the cost of all deposited funds.

## Creating Deposits

### Option 1: `payFeeAndFund` (One-Step)
The primary way to create a deposit. This endpoint accepts multiple payments where:
- **If fees are enabled**: The first payment is taken entirely as the fee, remaining payments are stored as funds
- **If fees are disabled**: All payments are treated as funds

**Important**: The first payment is consumed entirely as a fee (when fees are enabled), not split between fee and funds.

Parameters:
- `deposit_key`: The 32-byte check address (ED25519 public key) where funds will be stored
- `expiration`: Timestamp in milliseconds when the deposit expires

The endpoint can also be used to add more fwith a configured fee token
2. Then call `fund` to deposit the actual tokens (must be same depositor)

The `fund` endpoint verifies that sufficient fees have been paid to cover the total number of funds being deposited. This approach is particularly useful for the `forward` operation, where the destination deposit must exist with fees paid in advance
1. First call `depositFees` to pay the fee in a whitelisted token
2. Then call `fund` to deposit the actual tokens (must be same depositor)

The `fund` endpoint verifies that sufficient fees have been paid to cover the number of tokens being deposited.

## Claiming Funds

Use the `claim` endpoint with:
- `deposit_key`: The check address containing the deposit
- `signature`: ED25519 signature proving ownership of the check's private key

The signature must be generated by signing the caller's address with the private key corresponding to the deposit_key.

If the signature is valid and the deposit hasn't expired:
- All deposited funds are transferred to the caller
- Required fees (if fees enabled) are collected by the contract: `fee_collected = base_fee × number_of_funds`
- Any excess fees are returned to the original depositor
- The deposit is removed from storage
Expired Deposits

If a deposit has expired and hasn't been claimed, anyone can trigger the withdrawal by calling `withdrawExpired`:
- `deposit_key`: The check address containing the expired deposit

This returns all deposited funds plus all fees to the original depositor. No signature is required, but the deposit must have passed its expiration timestamp.

**Important**: Current block timestamp must be > expiration timestampclaim everything by calling `withdraw`:
- `address`: The check address containing the expired deposit

Thideposit_key`: The current check address (source)
- `forward_deposit_key`: The new check address (destination)
- `signature`: ED25519 signature proving ownership of the source check

**Critical Requirement**: The destination deposit must already exist with sufficient fees paid in advance. Use `depositFees` to create the destination first.

The forward operation:
1. Validates the signature for the source deposit
2. Collects required fees from the source deposit
3. Returns any excess fees from source to the original depositor
4. Appends source funds to the destination deposit
5. Updates destination's expiration to source's expiration
6. Removes the source deposit from storage

**Important**: The caller must be the depositor of the destination deposit, and the destination must have sufficient fees to cover the combined total of existing funds plus forwarded funds.

After forwarding, the funds belong to the destination deposit and will go to the destination's depositor if withdrawn after expiration
## Contract Owner Operations

The contract owner has exclusive access to fee management endpoints:

### `setFeesDisabled(bool)`
Globally enables or disables fee requirements:
- When `true`: No fees are required for any operation (deposit creation, claims)
- When `false`: Fees are validated based on configured fee variants
- Allows flexibility to run the contract in free mode or paid mode

### `setFee(token_id, fee_amount)`
Configures the fee for a specific token:
- Sets the base fee amount for the given token identifier
- Fee amount of 0 effectively disables that token for fees
- Total fee charged = `base_fee × number_of_funds` in the deposit
- Can be used to add new fee tokens, update existing ones, or disable tokens

### `claimFees()`
Withdraws all collected fees to the owner:
- Transfers all accumulated fees across all tokens in a single multi-payment transaction
- Clears the collected fees storage
- Only fees collected from claims and forwards are included (not initial deposits)- Consumes fees from the current deposit
- Moves funds to the forwarded address
- Returns any remaining fees to the original depositor

After forwarding, if the new deposit expires and is withdrawn, funds go to the depositor address recorded in the forwarded deposit.
