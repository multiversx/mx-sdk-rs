name: File sizes

on:
  pull_request:

jobs:
  sizes_report:
    name: Report WASM file sizes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
      - name: Download base report
        uses: dawidd6/action-download-artifact@v2
        continue-on-error: true
        with:
          workflow: actions.yml
          name: sizes
          commit: ${{github.event.pull_request.base.sha}}
          path: base-sizes
      - name: Download current branch report
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: actions.yml
          name: sizes
          path: current-sizes
      - name: Generate report
        id: sizes-report
        run: |
          source .github/workflows/env
          python tools/size-report/size_report.py base-sizes/sizes.txt current-sizes/sizes.txt --allow-missing
      - name: Find sizes report comment
        uses: peter-evans/find-comment@v1
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: Build output
      - name: Create or update sizes report comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.fc.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.sizes-report.outputs.build-log }}
          edit-mode: replace
